# Server-Side Request Forgery (SSRF)

**Server-Side Request Forgery (SSRF)** is a security vulnerability that occurs when an attacker can manipulate a server to make requests on their behalf, often to internal or unintended network locations. SSRF vulnerabilities allow attackers to send crafted requests from the application server, bypassing usual access controls and gaining access to otherwise restricted resources.

### How SSRF Works:

In SSRF attacks, an attacker can supply or manipulate URLs in the application's request parameters to make the server request unintended resources. Since the server typically has higher access privileges than external users, attackers exploit this by making the server connect to internal services, metadata endpoints, or external systems under their control. This can expose sensitive information, facilitate port scanning of internal networks, or even lead to remote code execution if certain endpoints are vulnerable.

Key elements of SSRF:

- **Unvalidated URL inputs** where attackers can specify URLs for the server to retrieve
- **Target internal services** like databases, internal APIs, or cloud instance metadata
- **Controls** to mitigate SSRF such as whitelisting trusted endpoints, implementing network segmentation, and avoiding user-controlled URL parameters

When reviewing the collection we can see three potential requests that involve URLs.

- **POST /community/api/v2/community/posts**
- **POST /workshop/api/shop/orders/return_order?order_id=4000**
- **POST workshop/api/merchant/contact_mechanic**
- 

**Challenge 11 - Make crAPI send an HTTP call to “[www.google.com](https://owasp.org/www-project-crapi/www.google.com)” and return the HTTP response.**

First Attack: 
The application sends a request to a local API endpoint specified by a parameter called `mechanic_api`. In the original request, the endpoint URL points to an internal address (`127.0.0.1`). This response shows that the server makes the request on behalf of the client to the specified internal address. Successful responses indicate the server may be processing arbitrary URLs, which suggests SSRF vulnerability.

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image.png)

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image%201.png)

In another test, the `mechanic_api` parameter is altered to point to an external URL (`https://www.google.com`). This request is successful, and the server's response includes HTML content from Google. This shows that the application has no restriction on external URLs, allowing an attacker to direct the server to request arbitrary URLs on the internet.

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image%202.png)

Second Attack: 
The `mechanic_api` parameter is modified to point to a unique URL generated by Webhook.site. The attacker can observe that Webhook.site captures the incoming request from the vulnerable application, showing that SSRF is successfully exploited. This proves that the server can be manipulated to send requests to third-party services under the attacker’s control.

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image%201.png)

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image%203.png)

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image%204.png)

The captured request on Webhook.site includes sensitive headers like authorization tokens, demonstrating that SSRF can expose sensitive data to external parties. This is a critical security risk, as it could lead to unauthorized access to internal services or leakage of sensitive information.

![image.png](Server-Side%20Request%20Forgery%20(SSRF)%201354a9b54b6a807f8436cf3db3c0485d/image%205.png)

Enterprise-Grade Mitigations for SSRF (2024)

In an enterprise-level setting, protecting against SSRF vulnerabilities requires a combination of strict validation, network segmentation, and modern security practices. Here are the top 4-5 most important SSRF mitigations:

1. **Input Validation and URL Whitelisting**
    - Implement strict validation for any URLs or endpoints that users can supply. Only allow URLs that match a predefined set of trusted, whitelisted domains or IP addresses.
    - Avoid allowing full URL input by users. Instead, provide predefined, selectable options for internal resources or trusted external services.
    
    **Industry Tools**: NGINX, AWS API Gateway, Express-Validator (Node.js), Yup (JavaScript/React)
    
2. **Network Segmentation and Isolation of Internal Services**
    - Use network segmentation to separate sensitive internal services from externally accessible networks. Block access to internal resources (such as localhost and private IP ranges) from the application layer.
    - Implement network controls, such as firewall rules and subnet restrictions, to prevent unauthorized requests to internal services.
    
    **Industry Tools**: AWS Security Groups and VPCs, Azure Network Security Groups (NSGs), Google Cloud VPC Firewall Rules
    
3. **Metadata Endpoint Protection**
    - For cloud environments, restrict access to instance metadata endpoints by disabling direct access from application servers or using instance metadata service version 2 (IMDSv2) in AWS, which requires session-based authentication.
    
    **Industry Tools**: AWS Instance Metadata Service v2 (IMDSv2), Google Cloud IAM, Azure Instance Metadata Service (IMDS)
    
4. **Web Application Firewall (WAF) with SSRF Rules**
    - Deploy a WAF configured with SSRF-specific rules to detect and block potential SSRF payloads. The WAF should monitor for common SSRF patterns, such as requests to local or private IP addresses.
    - Regularly update WAF rules to protect against new SSRF techniques.
    
    **Industry Tools**: AWS WAF, Cloudflare WAF, Imperva WAF
    
5. **Implement Role-Based Access Control (RBAC) and Principle of Least Privilege**
    - Use RBAC to ensure that applications and services only have access to the specific resources they need. Configure service accounts with the minimum permissions required to perform their tasks.
    - Avoid granting broad access to internal resources or sensitive endpoints, limiting exposure in the event of SSRF exploitation.
    
    **Industry Tools**: AWS IAM, Azure Active Directory (AAD), HashiCorp Vault